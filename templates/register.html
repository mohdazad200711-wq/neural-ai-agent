{% extends "base.html" %}

{% block title %}Register - Join AyurAI{% endblock %}

{% block content %}
<div class="container">
    <div class="auth-container glass-panel">
        <h2
            style="font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(to right, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
            Join AyurAI</h2>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">Start your wellness journey with AI guidance.</p>

        <form id="registerForm">
            <div class="form-group">
                <label for="username">Full Name</label>
                <input type="text" id="username" class="form-control" placeholder="Enter your name" required>
            </div>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="name@example.com" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" class="form-control" placeholder="+1 234 567 890" required>
            </div>
            <div class="form-group">
                <label for="country">Country</label>
                <select id="country" class="form-control" style="background: rgba(0,0,0,0.2);">
                    <option value="India">India</option>
                    <option value="USA">USA</option>
                    <option value="UK">United Kingdom</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="Germany">Germany</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="••••••••" required>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Create Account</button>
        </form>

        <div id="verificationSection" class="ai-call-box"
            style="display: none; border-color: var(--secondary-color); background: rgba(218, 165, 32, 0.05);">
            <p style="font-size: 0.9rem; margin-bottom: 1rem; color: var(--secondary-color);"><strong>Verify for Medical
                    Access</strong><br>Upload legal proof to unlock restricted recommendations.</p>
            <select id="proofType" class="form-control" style="margin-bottom: 1rem; background: rgba(0,0,0,0.2);">
                <option value="ID Card">Government ID</option>
                <option value="Medical Certificate">Medical Certificate</option>
                <option value="Legal Affidavit">Legal Affidavit</option>
            </select>
            <button id="verifyBtn" class="ai-call-btn"
                style="background: linear-gradient(45deg, var(--secondary-color), #B8860B);">
                <i class="fas fa-file-signature"></i> Verify Legal Proof
            </button>
        </div>

        <div class="ai-call-box">
            <p style="font-size: 0.9rem; margin-bottom: 1rem;">Need help with registration? Call our AI agent!</p>
            <button id="aiCallBtn" class="ai-call-btn">
                <i class="fas fa-robot"></i> AI Agent Call
            </button>
            <div id="aiResponse" class="ai-response-area"></div>
        </div>
    </div>
</div>

<!-- AI Confirmation Call Modal -->
<div id="callBackdrop" class="call-modal-backdrop"></div>
<div id="callModal" class="call-modal">
    <div class="call-avatar">
        <i class="fas fa-robot"></i>
    </div>
    <h3 style="color: var(--accent-color); margin-bottom: 0.5rem;">Incoming Call</h3>
    <p id="callStatus" style="color: var(--text-muted); margin-bottom: 1.5rem;">AyurBot AI Assistant</p>

    <div id="callChat"
        style="display: none; text-align: left; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 15px; margin-bottom: 1rem; max-height: 150px; overflow-y: auto;">
        <p style="color: var(--accent-color); font-size: 0.9rem;"><strong>AyurBot:</strong> <span id="callMsg"></span>
        </p>
    </div>

    <div class="call-actions">
        <button id="declineCall" class="btn-call btn-decline"><i class="fas fa-phone-slash"></i></button>
        <button id="answerCall" class="btn-call btn-answer"><i class="fas fa-phone"></i></button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const registerForm = document.getElementById('registerForm');
    const aiCallBtn = document.getElementById('aiCallBtn');
    const aiResponse = document.getElementById('aiResponse');
    const verificationSection = document.getElementById('verificationSection');
    const verifyBtn = document.getElementById('verifyBtn');

    // Call Modal Elements
    const callModal = document.getElementById('callModal');
    const callBackdrop = document.getElementById('callBackdrop');
    const answerCall = document.getElementById('answerCall');
    const declineCall = document.getElementById('declineCall');
    const callStatus = document.getElementById('callStatus');
    const callChat = document.getElementById('callChat');
    const callMsg = document.getElementById('callMsg');

    // Placeholder for loader functions
    function showLoader() { console.log("Showing loader..."); }
    function hideLoader() { console.log("Hiding loader..."); }

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const country = document.getElementById('country').value;

        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, phone, country })
            });
            const data = await response.json();
            alert(data.message);
            // Show verification section after registration
            registerForm.style.display = 'none';
            verificationSection.style.display = 'block';
        } catch (error) {
            console.error('Error:', error);
            alert('Something went wrong. Please try again.');
        }
    });

    verifyBtn.addEventListener('click', async () => {
        const proofType = document.getElementById('proofType').value;
        showLoader();
        try {
            const response = await fetch('/api/verify_proof', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ proof_type: proofType })
            });
            const data = await response.json();
            alert(data.message);

            // Trigger AI Confirmation Call after verification
            triggerAICall();
        } catch (error) {
            console.error('Error:', error);
            alert('Verification failed. Please try again.');
        } finally {
            hideLoader();
        }
    });

    function triggerAICall() {
        callModal.style.display = 'block';
        callBackdrop.style.display = 'block';
    }

    answerCall.addEventListener('click', async () => {
        callStatus.innerText = "Connected";
        answerCall.style.display = 'none';
        callChat.style.display = 'block';

        try {
            const response = await fetch('/api/ai_call_script');
            const data = await response.json();
            const messages = data.script;

            let i = 0;
            const interval = setInterval(() => {
                if (i < messages.length) {
                    callMsg.innerText = messages[i];
                    i++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        closeCall();
                        window.location.href = '/remedy';
                    }, 2000);
                }
            }, 3000);
        } catch (error) {
            console.error('Error fetching script:', error);
            callMsg.innerText = "Connections issues. Please visit the remedies page.";
            setTimeout(() => window.location.href = '/remedy', 2000);
        }
    });

    declineCall.addEventListener('click', () => {
        closeCall();
        window.location.href = '/remedy';
    });

    function closeCall() {
        callModal.style.display = 'none';
        callBackdrop.style.display = 'none';
    }

    aiCallBtn.addEventListener('click', async () => {
        aiResponse.innerText = "Connecting to AyurBot...";
        const messages = [
            "Namaste! Type your name and email to join us.",
            "I can help you analyze your symptoms after you register.",
            "Your data is safe with our AI-encrypted vaults.",
            "Join thousands of users on their path to wellness!"
        ];

        // Simulate a call response
        setTimeout(() => {
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            aiResponse.innerText = `AyurBot: "${randomMsg}"`;
        }, 1000);
    });
</script>
{% endblock %}